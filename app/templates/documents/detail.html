{% extends "layouts/crud_base.html" %}

{% block title %}Документ #{{ document.id }}{% endblock %}

{% block crud_nav %}
  <nav class="side-nav">
    <a href="/documents" class="side-nav__item">Документы</a>
  </nav>
{% endblock %}

{% block crud_content %}
  <section class="card card--wide">
    <header class="card__header card__header--row">
      <div>
        <h1>Документ #{{ document.id }}</h1>
        <p class="card__subtitle">Статус: {{ status_labels.get(document.status, document.status) }}</p>
      </div>
      <div class="card__actions">
        <a class="button button--ghost" href="/documents">Назад к списку</a>
      </div>
    </header>
    <div class="card__body">
      <div class="stack">
        <div>
          <h2>Данные документа</h2>
          <dl class="definition-list">
            <div>
              <dt>Название</dt>
              <dd>{{ document.title }}</dd>
            </div>
            <div>
              <dt>Описание</dt>
              <dd>{{ document.description or "—" }}</dd>
            </div>
            <div>
              <dt>Создан</dt>
              <dd>{{ document.created_at.strftime("%d.%m.%Y %H:%M") }}</dd>
            </div>
            <div>
              <dt>Обновлен</dt>
              <dd>{{ document.updated_at.strftime("%d.%m.%Y %H:%M") }}</dd>
            </div>
          </dl>
        </div>
        <div>
          <h2>Экономические метрики</h2>
          {% set can_edit_metrics = document.status != "APPROVED" %}
          {% if metrics %}
            <div class="table">
              <div class="table__row table__row--head">
                <div class="table__cell">Метрика</div>
                <div class="table__cell">Значение</div>
                <div class="table__cell">Единицы измерения</div>
                {% if can_edit_metrics %}
                  <div class="table__cell">Действия</div>
                {% endif %}
              </div>
              {% for metric in metrics %}
                <div class="table__row">
                  <div class="table__cell">{{ metric.name }}</div>
                  <div class="table__cell">{{ metric.value }}</div>
                  <div class="table__cell">{{ metric.unit }}</div>
                  {% if can_edit_metrics %}
                    <div class="table__cell">
                      <form
                        method="post"
                        action="/documents/{{ document.id }}/metrics/{{ metric.id }}"
                        data-method="delete"
                        data-metric-form
                      >
                        <button type="submit" class="button button--danger">Удалить</button>
                      </form>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p>Метрики пока не добавлены.</p>
          {% endif %}
          {% if can_edit_metrics %}
            {% if metrics %}
              <div class="stack">
                {% for metric in metrics %}
                  <form
                    class="form"
                    method="post"
                    action="/documents/{{ document.id }}/metrics/{{ metric.id }}"
                    data-method="put"
                    data-metric-form
                  >
                    <label class="form__label">
                      Метрика
                      <input type="text" name="name" value="{{ metric.name }}" required>
                    </label>
                    <label class="form__label">
                      Значение
                      <input type="text" name="value" value="{{ metric.value }}" required>
                    </label>
                    <label class="form__label">
                      Единицы измерения
                      <input type="text" name="unit" value="{{ metric.unit }}" required>
                    </label>
                    <div class="form__actions">
                      <button type="submit" class="button button--ghost">Сохранить изменения</button>
                    </div>
                  </form>
                {% endfor %}
              </div>
            {% endif %}
            <form class="form" method="post" action="/documents/{{ document.id }}/metrics" data-metric-form>
              <label class="form__label">
                Метрика
                <input type="text" name="name" required>
              </label>
              <label class="form__label">
                Значение
                <input type="text" name="value" required>
              </label>
              <label class="form__label">
                Единицы измерения
                <input type="text" name="unit" required>
              </label>
              <div class="form__actions">
                <button type="submit" class="button button--primary">Добавить метрику</button>
              </div>
            </form>
          {% else %}
            <p>Редактирование метрик недоступно для согласованных документов.</p>
          {% endif %}
          <script>
            function bindMetricForms() {
              const forms = document.querySelectorAll("[data-metric-form]");
              forms.forEach((form) => {
                if (!(form instanceof HTMLFormElement)) {
                  return;
                }
                form.addEventListener("submit", async (event) => {
                  event.preventDefault();
                  const method = form.dataset.method?.toUpperCase();
                  if (!method) {
                    form.submit();
                    return;
                  }
                  const response = await fetch(form.action, {
                    method,
                    body: new FormData(form),
                    headers: { "X-Requested-With": "fetch" },
                  });
                  if (!response.ok) {
                    alert("Не удалось выполнить действие с метрикой");
                    return;
                  }
                  const payload = await response.json();
                  if (payload.redirect_url) {
                    window.location.assign(payload.redirect_url);
                  }
                });
              });
            }

            bindMetricForms();
          </script>
        </div>
        <div>
          <h2>RICE-оценка</h2>
          {% set can_edit_rice = document.status == "APPROVAL" %}
          {% if rices %}
            <div class="tabs" data-rice-tabs>
              <div class="tabs__header">
                {% for rice in rices %}
                  <button
                    type="button"
                    class="tabs__tab"
                    data-rice-tab
                    data-target="rice-{{ rice.id }}"
                  >
                    Пользователь #{{ rice.author_id }}
                  </button>
                {% endfor %}
              </div>
              <div class="tabs__body">
                {% for rice in rices %}
                  <div class="tabs__panel" id="rice-{{ rice.id }}" data-rice-panel>
                    <dl class="definition-list">
                      <div>
                        <dt>Охват</dt>
                        <dd>{{ rice.reach }}</dd>
                      </div>
                      <div>
                        <dt>Влияние</dt>
                        <dd>{{ rice.impact }}</dd>
                      </div>
                      <div>
                        <dt>Уверенность</dt>
                        <dd>{{ rice.confidence }}</dd>
                      </div>
                      <div>
                        <dt>Трудозатраты</dt>
                        <dd>{{ rice.effort }}</dd>
                      </div>
                      <div>
                        <dt>Итоговый балл</dt>
                        <dd>{{ "%.2f"|format(rice.score) }}</dd>
                      </div>
                    </dl>
                    {% if can_edit_rice and rice.author_id == user.id %}
                      <form
                        class="form"
                        method="post"
                        action="/documents/{{ document.id }}/rice/{{ rice.id }}"
                        data-method="put"
                        data-rice-form
                      >
                        <label class="form__label">
                          Охват
                          <input type="number" name="reach" step="0.01" value="{{ rice.reach }}" required>
                        </label>
                        <label class="form__label">
                          Влияние
                          <input type="number" name="impact" step="0.01" value="{{ rice.impact }}" required>
                        </label>
                        <label class="form__label">
                          Уверенность
                          <input type="number" name="confidence" step="0.01" value="{{ rice.confidence }}" required>
                        </label>
                        <label class="form__label">
                          Трудозатраты
                          <input type="number" name="effort" step="0.01" value="{{ rice.effort }}" required>
                        </label>
                        <div class="form__actions">
                          <button type="submit" class="button button--ghost">Сохранить изменения</button>
                        </div>
                      </form>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <p>RICE-оценки пока не добавлены.</p>
          {% endif %}
          {% if can_edit_rice %}
            <form class="form" method="post" action="/documents/{{ document.id }}/rice" data-rice-form>
              <label class="form__label">
                Охват
                <input type="number" name="reach" step="0.01" required>
              </label>
              <label class="form__label">
                Влияние
                <input type="number" name="impact" step="0.01" required>
              </label>
              <label class="form__label">
                Уверенность
                <input type="number" name="confidence" step="0.01" required>
              </label>
              <label class="form__label">
                Трудозатраты
                <input type="number" name="effort" step="0.01" required>
              </label>
              <div class="form__actions">
                <button type="submit" class="button button--primary">Добавить RICE-оценку</button>
              </div>
            </form>
          {% else %}
            <p>Редактирование RICE-оценки доступно только на согласовании.</p>
          {% endif %}
          <script>
            function bindRiceTabs() {
              const tabsRoot = document.querySelector("[data-rice-tabs]");
              if (!tabsRoot) {
                return;
              }
              const tabs = Array.from(tabsRoot.querySelectorAll("[data-rice-tab]"));
              const panels = Array.from(tabsRoot.querySelectorAll("[data-rice-panel]"));
              if (!tabs.length) {
                return;
              }
              const activate = (tab) => {
                const targetId = tab.dataset.target;
                tabs.forEach((item) => item.classList.toggle("tabs__tab--active", item === tab));
                panels.forEach((panel) => panel.classList.toggle("tabs__panel--active", panel.id === targetId));
              };
              tabs.forEach((tab) => {
                tab.addEventListener("click", () => activate(tab));
              });
              activate(tabs[0]);
            }

            function bindRiceForms() {
              const forms = document.querySelectorAll("[data-rice-form]");
              forms.forEach((form) => {
                if (!(form instanceof HTMLFormElement)) {
                  return;
                }
                form.addEventListener("submit", async (event) => {
                  event.preventDefault();
                  const method = form.dataset.method?.toUpperCase();
                  if (!method) {
                    form.submit();
                    return;
                  }
                  const response = await fetch(form.action, {
                    method,
                    body: new FormData(form),
                    headers: { "X-Requested-With": "fetch" },
                  });
                  if (!response.ok) {
                    alert("Не удалось выполнить действие с RICE-оценкой");
                    return;
                  }
                  const payload = await response.json();
                  if (payload.redirect_url) {
                    window.location.assign(payload.redirect_url);
                  }
                });
              });
            }

            bindRiceTabs();
            bindRiceForms();
          </script>
        </div>
        <div>
          <h2>Комментарии к документу</h2>
          {% if document_comments %}
            <div class="stack">
              {% for comment in document_comments %}
                <div class="card">
                  <div class="card__body">
                    <div>{{ comment.content }}</div>
                    <div class="text-muted">{{ comment.created_at.strftime("%d.%m.%Y %H:%M") }}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p>Комментариев пока нет.</p>
          {% endif %}
          <form class="form" method="post" action="/comments">
            <input type="hidden" name="document_id" value="{{ document.id }}">
            <label class="form__label">
              Добавить комментарий
              <textarea name="content" rows="3" required></textarea>
            </label>
            <div class="form__actions">
              <button type="submit" class="button button--primary">Отправить</button>
            </div>
          </form>
        </div>
        <div>
          <h2>Согласование</h2>
          {% if approval %}
            <p class="card__subtitle">Статус согласования: {{ approval_status_labels.get(approval.status, approval.status) }}</p>
            <div class="table">
              <div class="table__row table__row--head">
                <div class="table__cell">Согласующий</div>
                <div class="table__cell">Статус</div>
                <div class="table__cell">Действия</div>
              </div>
              {% for step in approval_steps %}
                <div class="table__row">
                  <div class="table__cell">Пользователь #{{ step.approver_id }}</div>
                  <div class="table__cell">{{ step_status_labels.get(step.status, step.status) }}</div>
                  <div class="table__cell">
                    {% if step.approver_id == user.id and step.status == "PENDING" %}
                      <form method="post" action="/approvals/{{ approval.id }}/steps/{{ step.id }}/approve">
                        <button type="submit" class="button button--primary">Согласовать</button>
                      </form>
                      <form method="post" action="/approvals/{{ approval.id }}/steps/{{ step.id }}/reject" class="form form--inline">
                        <input type="text" name="reason" placeholder="Причина отказа" required>
                        <button type="submit" class="button button--ghost">Отклонить</button>
                      </form>
                    {% elif step.status == "REJECTED" %}
                      <div class="text-muted">{{ step.rejection_reason or "Причина не указана" }}</div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="stack">
              <h3>Комментарии к согласованию</h3>
              {% if approval_comments %}
                {% for comment in approval_comments %}
                  <div class="card">
                    <div class="card__body">
                      <div>{{ comment.content }}</div>
                      <div class="text-muted">{{ comment.created_at.strftime("%d.%m.%Y %H:%M") }}</div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <p>Комментариев к согласованию пока нет.</p>
              {% endif %}
              <form class="form" method="post" action="/comments">
                <input type="hidden" name="approval_id" value="{{ approval.id }}">
                <label class="form__label">
                  Добавить комментарий
                  <textarea name="content" rows="3" required></textarea>
                </label>
                <div class="form__actions">
                  <button type="submit" class="button button--primary">Отправить</button>
                </div>
              </form>
            </div>
          {% else %}
            <p>Согласование не начато.</p>
          {% endif %}
          {% if document.status in ["DRAFT", "REVISION_REQUIRED"] %}
            <form class="form" method="post" action="/documents/{{ document.id }}/submit">
              <label class="form__label">
                Согласующие (ID через запятую)
                <input type="text" name="approver_ids" required>
              </label>
              <div class="form__actions">
                <button type="submit" class="button button--primary">Отправить на согласование</button>
              </div>
            </form>
          {% endif %}
        </div>
        <div>
          <h2>Редактирование</h2>
          {% set form_action = "/documents/" ~ document.id %}
          {% set method_override = "put" %}
          {% set submit_label = "Сохранить" %}
          {% include "documents/form.html" %}
        </div>
        <div>
          <h2>Архивирование</h2>
          <form class="form" method="post" action="/documents/{{ document.id }}" data-method="delete">
            <div class="form__actions">
              <button type="submit" class="button button--danger">Архивировать</button>
            </div>
          </form>
          <script>
            // Функция отправляет запрос на архивирование документа.
            function bindArchiveForm() {
              const form = document.currentScript?.previousElementSibling;
              if (!form || !(form instanceof HTMLFormElement)) {
                return;
              }
              form.addEventListener("submit", async (event) => {
                event.preventDefault();
                const response = await fetch(form.action, {
                  method: "DELETE",
                  headers: { "X-Requested-With": "fetch" },
                });
                if (!response.ok) {
                  alert("Не удалось архивировать документ");
                  return;
                }
                const payload = await response.json();
                if (payload.redirect_url) {
                  window.location.assign(payload.redirect_url);
                }
              });
            }

            bindArchiveForm();
          </script>
        </div>
      </div>
    </div>
  </section>
{% endblock %}
